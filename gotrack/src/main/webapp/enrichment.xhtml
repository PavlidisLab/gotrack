<ui:composition template="/WEB-INF/templates/mainLayout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
                xmlns:comps="http://xmlns.jcp.org/jsf/composite/composites"
                xmlns:of="http://omnifaces.org/functions"
                xmlns:a="http://xmlns.jcp.org/jsf/passthrough">


    <ui:define name="metadata">
        <f:metadata>
            <f:event type="preRenderView" listener="#{enrichmentView.init}"/>
        </f:metadata>
    </ui:define>
    <ui:define name="pageTitle">GOtrack</ui:define>
    <ui:define name="css">
        <h:outputStylesheet library="css" name="enrichment.css"/>
        <h:outputStylesheet library="css" name="gograph.css"/>
    </ui:define>
    <ui:define name="js">
        <h:outputScript library="js" name="utility.js"/>

        <!-- Highcharts stuff -->
        <script src="https://code.highcharts.com/6.0.7/highcharts.js" type="text/javascript"></script>
        <script src="https://code.highcharts.com/6.0.7/modules/exporting.js" type="text/javascript"></script>
        <script src="https://code.highcharts.com/6.0.7/modules/export-data.js" type="text/javascript"></script>
        <script src="https://code.highcharts.com/6.0.7/modules/histogram-bellcurve.js" type="text/javascript"></script>
        <script src="https://code.highcharts.com/6.0.7/highcharts-more.js" type="text/javascript"></script>

        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <h:outputScript library="js" name="dagre-d3.min.js"/>

        <h:outputScript library="js" name="plotting.js"/>
        <h:outputScript library="js" name="gograph.js"/>
        <h:outputScript library="js" name="enrichment.js"/>

        <h:outputScript rendered="#{enrichmentView.combinedAnalysis.success}">
            $(document).ready(function () {
                console.log('Loading Previous Enrichment Analysis');
                loadPreviousEnrichment();
            });
        </h:outputScript>

    </ui:define>
    <ui:define name="left_right_layout">
        <p:layoutUnit id="left" position="west" size="350" resizable="false"
                      collapsible="true" header="Options" minSize="350">
            <h:form id="formSelect">

                <p:panelGrid style="margin:10px 0 10px 0" cellpadding="5" styleClass="no-border">
                    <p:row>
                        <p:column>
                            <h:outputText value="" styleClass="help-icon" title="Select the species you would like to run an enrichment analysis for."/>
                            <h:outputText value="Species:"/>
                        </p:column>

                        <p:column>
                            <p:selectOneMenu id="selectspecies"
                                             value="#{enrichmentView.selectedSpecies}" converter="speciesConverter">
                                <p:ajax event="change" process="@this" listener="#{enrichmentView.filterSimilarityReferenceEditions()}"
                                        update=":formSelect:geneList :formSelect:similarityDateSelector"/>
                                <f:selectItems value="#{cache.speciesList}" var="spec"
                                               itemValue="#{spec}" itemLabel="#{spec.commonName}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                </p:panelGrid>

                <p:dataList id="geneList" value="#{enrichmentView.selectedGenes}"
                            var="gene" type="unordered" itemType="none" styleClass="geneList">
                    <f:facet name="header">
                        Gene Hit List (Total: #{fn:length(enrichmentView.selectedGenes)})
                    </f:facet>

                    <p:commandLink update=":geneDetail"
                                   oncomplete="PF('geneDialog').show()" title="View Detail"
                                   styleClass="ui-icon ui-icon-search">
                        <f:setPropertyActionListener value="#{gene}"
                                                     target="#{enrichmentView.viewGene}"/>
                    </p:commandLink>
                    <p:commandLink update=":globalGrowl, :formSelect:geneList"
                                   title="Remove" action="#{enrichmentView.removeGene(gene)}"
                                   styleClass="ui-icon ui-icon-trash"/>
                    <p:link value="#{gene.symbol}" outcome="genes" target="_blank" style="margin-right:10px;width:80px;">
                        <f:param name="accession" value="#{gene.accession.accession}"/>
                    </p:link>
                    <h:outputText style="width:160px;" rendered="${gene.name.length() le 25}"
                                  value="#{gene.name}"/>
                    <h:outputText style="width:160px;" rendered="${gene.name.length() > 25}"
                                  value="${''.concat(fn:substring(gene.name, 0, 25)).concat('...')}"
                                  title="#{gene.name}"/>
                    <f:facet name="footer">
                        <p:commandButton icon="fa fa-plus" value="Add"
                                         oncomplete="PF('addGenesDlg').show()"/>
                        <p:commandButton icon="fa fa-plus" value="Add Multiple"
                                         oncomplete="PF('addMultipleGenesDlg').show()"/>
                        <p:commandButton icon="fa fa-trash" value="Clear"
                                         action="#{enrichmentView.removeAllGenes()}"
                                         update=":formSelect:geneList :formSelect:runEnrichmentBtn :formAddGenes"/>
                    </f:facet>
                </p:dataList>

                <h3 class="center">Settings</h3>
                <p:panelGrid id="enrichmentSettingsPanel" style="margin-bottom:10px;width:100%;"
                             cellpadding="5" styleClass="no-border">

                    <p:row>
                        <p:column>
                            <h:outputText styleClass="help-icon" title="Which aspects (Cellular Component, Biological Process, Molecular Function) to include in the analysis."/>
                            <h:outputText value="Aspect:"/>
                        </p:column>
                        <p:column>
                            <p:selectManyButton value="#{enrichmentView.enrichmentOptions.aspects}"
                                                converter="omnifaces.GenericEnumConverter">
                                <f:selectItems value="#{cache.aspects}"
                                               var="aspect" itemValue="#{aspect}" itemLabel="#{aspect}"/>
                            </p:selectManyButton>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <h:outputText styleClass="help-icon" a:title-id="#multipleTest-title"/>
                            <h:outputText value="Multiple Tests:"/>
                            <div style="display: none;">
                                <div id="multipleTest-title">
                                    <div class="overlay-help">
                                        <p>Type of multiple tests correction to apply.</p>
                                        <ul style="margin: 0.2em 1em;">
                                            <li><b>Bonferroni:</b> Reject null hypotheses who P-values are less than the given threshold.</li>
                                            <li><b>BH step-up:</b> Benjaminiâ€“Hochberg procedure, controls FDR at given threshold level.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </p:column>
                        <p:column>
                            <p:selectOneMenu value="#{enrichmentView.enrichmentOptions.multipleTestCorrection}">
                                <f:selectItems value="#{cache.multipleTestCorrections}"
                                               var="test" itemValue="#{test}" itemLabel="#{test.label}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <h:outputText styleClass="help-icon" title="Threshold to use for the above multiple test correction method. This establishes the definition of &quot;significant&quot; for the results displays."/>
                            <h:outputText value="Threshold:"/>
                        </p:column>

                        <p:column>
                            <p:inputNumber value="#{enrichmentView.enrichmentOptions.threshold}"
                                            emptyValue="zero" decimalPlaces="4" style="max-width: 100px"/>
                        </p:column>
                    </p:row>


                    <p:row>
                        <p:column>
                            <h:outputText styleClass="help-icon" title="Select only those terms with at least this number of genes associated with them. Used to to remove overly-specific terms from analysis."/>
                            <h:outputText value="Min Geneset:"/>
                        </p:column>
                        <p:column>
                            <p:spinner id="annotatedPopulationMinInput"
                                       value="#{enrichmentView.enrichmentOptions.minAnnotatedPopulation}" min="0"/>
                        </p:column>
                    </p:row>


                    <p:row>
                        <p:column>
                            <h:outputText styleClass="help-icon" title="Select only those terms with at most this number of genes associated with them (0 for no maximum). Used to remove overly-general terms from analysis."/>
                            <h:outputText value="Max Geneset:"/>
                        </p:column>
                        <p:column>
                            <p:spinner id="annotatedPopulationMaxInput"
                                       value="#{enrichmentView.enrichmentOptions.maxAnnotatedPopulation}" min="0"/>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column colspan="2">
                            <p:separator style="max-width:200px"/>
                        </p:column>
                    </p:row>

                    <p:row>
                        <p:column>
                            <h:outputText styleClass="help-icon" title="The analysis will generate a plot comparing the semantic similarity of the
                                    enrichment results between releases of GO/GOA. Select the version of GO/GOA that
                                    you would like to use as the reference edition."/>
                            <h:outputText value="Similarity Reference:"/>
                        </p:column>
                        <p:column>
                            <!--<p:calendar value="#{enrichmentView.similarityReferenceDate}" showButtonPanel="true" navigator="true" mask="true" required="true" beforeShowDay="enableAllTheseDays" maxdate="new Date();" pages="3"/>-->
                            <h:panelGrid id="similarityDateSelector" columns="2" style="border:none;">

                                <h:outputText value="Year" />
                                <h:outputText value="Release" />
                                <p:selectOneMenu id="year_select" value="#{enrichmentView.similarityReferenceYear}">
                                    <f:selectItems value="#{cache.getSpeciesYears( enrichmentView.selectedSpecies )}"/>
                                    <p:ajax event="change" process="@this" update="edition_select"
                                            listener="#{enrichmentView.filterSimilarityReferenceEditions}"/>
                                </p:selectOneMenu>

                                <p:selectOneMenu id="edition_select" value="#{enrichmentView.similarityReferenceEdition}"
                                                 converter="editionConverter">
                                    <f:selectItems value="#{enrichmentView.filteredSimilarityReferenceEditions}" var="ed"
                                                   itemLabel="#{of:formatDate(ed.date, 'MMM dd')}"
                                                   itemValue="#{ed}"/>
                                </p:selectOneMenu>
                            </h:panelGrid>
                        </p:column>
                    </p:row>


                </p:panelGrid>

                <p:separator style="max-width:200px; height:5px;"/>
                <div align="center" style="margin-top: 20px;">
                    <p:commandButton id="runEnrichmentBtn" value="Run Enrichment"
                                     widgetVar="runEnrichmentBtnWdg"
                                     action="#{enrichmentView.enrich()}" icon="fa fa-bar-chart"
                                     update=":formSelect:geneList :formSelect:runEnrichmentBtn :formSelect:enrichmentProgressBar :formEnrich:main-area :formEnrich:main-buttons :formEnrich:headerPanel"
                                     onclick="runEnrichmentOnClick();"
                                     oncomplete="runEnrichmentComplete(xhr, status, args);"
                                     disabled="#{fn:length(enrichmentView.selectedGenes) == 0}"/>
                </div>
                <div id="progressBarContainer" class="center disabled">
                    <p:progressBar id="enrichmentProgressBar" widgetVar="enrichmentProgressBarWdg" interval="500"
                                   ajax="true" value="#{enrichmentView.statusPoller.progress}"
                                   labelTemplate="{value}%" styleClass="animated" global="false"
                                   style="width:250px;margin: 25px auto 5px auto;"/>

                    <p:outputPanel autoUpdate="true" style="font-size:80%;">
                        <!-- &#8203 is a zero-width space so that the div container leaves space for the status text -->
                        <h:outputText value="#{enrichmentView.statusPoller.currentStatus}"/>&#8203;
                    </p:outputPanel>
                </div>

            </h:form>


            <!-- 			<f:facet name="footer">
                            <h:graphicImage library="img" width="130" height="110"
                                name="logo1.png" styleClass="center" />
                        </f:facet> -->
        </p:layoutUnit>
    </ui:define>
    <ui:define name="center_layout">
        <h:form id="formEnrich" styleClass="expand-tables">

            <div id="page-title">
                <h1>Enrichment Results</h1>
                <p:outputPanel id="headerPanel">
                    <h3 style="display: inline-block;">Edition #{enrichmentView.enrichmentTableEdition.edition} : #{enrichmentView.enrichmentTableEdition.date} (Total Significant: #{enrichmentView.combinedAnalysis.enrichmentAnalysis.getTermsSignificant( enrichmentView.enrichmentTableEdition ).size()})</h3>
                    <p:commandButton
                            disabled="#{not enrichmentView.combinedAnalysis.success}"
                            value=""
                            title="P-Value distribution"
                            style="margin-left:5px;display: inline-block;"
                            styleClass="no-value no-background fa-fix"
                            action="#{enrichmentView.createPValueHistogram()}"
                            icon="fa fa-bar-chart"
                            oncomplete="PF('chartDlgWdg').show();handleGraphHistogram(xhr, status, args);"/>
                </p:outputPanel>

            </div>

            <div style="white-space: nowrap; min-width: 1000px;">
                <div style="padding: 20px 20px 10px 20px; ">
                    <div class="well chart-container" style="margin-right:5px;">
                        <h:outputText value="" styleClass="help-icon" a:title-id="#termCountChart-title" style="position:absolute;z-index:99999;"/>
                        <div style="display: none;">
                            <div id="termCountChart-title">
                                <div class="overlay-help">
                                    <h3 style="margin-top: 0;">Description:</h3>
                                    <p><b>GO Term Counts by Edition</b> shows counts of unique GO Terms associated with this each enrichment analysis over time.</p>
                                    <h3>Legend Descriptions:</h3>
                                    <p><span style="color:#2bce48;">All Tested Terms</span>: Count of unique terms that passed all settings criteria.</p>
                                    <p><span style="color:#0075dc;">Significant Terms</span>: Count of unique terms that passed all settings criteria and were significant.</p>
                                    <p><span style="color:#993f00;">Rejected Terms</span>: Count of unique terms that did not pass all settings criteria.</p>

                                    <h3>Controls:</h3>
                                    <p><b>&lt;Click&gt;</b> any edition to view the enrichment results at that point in time in bottom table.</p>
                                    <p><b>&lt;Click&gt;</b> a legend item to toggle that series.</p>
                                    <p><b>&lt;Ctrl/Command&gt; + &lt;Click&gt;</b> a legend item to show only that series.</p>
                                </div>
                            </div>
                        </div>
                        <div id="hc_terms_container" style="height: 300px;"/>
                    </div>
                    <div class="well chart-container">
                         <h:outputText value="" styleClass="help-icon" a:title-id="#similarityChart-title" style="position:absolute;z-index:99999;"/>
                        <div style="display: none;">
                            <div id="similarityChart-title">
                                <div class="overlay-help">
                                    <h3 style="margin-top: 0;">Description:</h3>
                                    <p><b>Enrichment Similarity</b> shows Jaccard similarity of the sets of significantly enriched terms over time.</p>
                                    <h3>Legend Descriptions:</h3>
                                    <p>The series differ in which sets of terms we are comparing:</p>
                                    <p><span style="color:#2bce48;">All Terms</span>: Compare all significant terms.</p>
                                    <p><span style="color:#0075dc;">Top 5 Terms</span>: Compare the top 5 terms.</p>
                                    <p><span style="color:#993f00;">Parents of Top Terms</span>: Compare the top 5 terms and all of their ancestors.</p>
                                    <p><span style="color:#4c005c;">Genes Backing Top Terms</span>: Compare the genes that are responsible for the top 5 terms.</p>

                                    <h3>Controls:</h3>
                                    <p><b>&lt;Click&gt;</b> any edition to view the term sets described above.</p>
                                    <p><b>&lt;Click&gt;</b> a legend item to toggle that series.</p>
                                    <p><b>&lt;Ctrl/Command&gt; + &lt;Click&gt;</b> a legend item to show only that series.</p>
                                </div>
                            </div>
                        </div>
                        <div id="hc_similarity_container" style="height: 300px;"/>
                    </div>
                </div>

                <div style="text-align: center;padding: 10px 20px">
                    <h:outputText value="" styleClass="help-icon" a:title-id="#mainButtons-title"/>
                    <div style="display: none;">
                        <div id="mainButtons-title">
                            <div class="overlay-help">
                                <p>These buttons provide a means to visualize the changes in enrichment results over the
                                    history of this hitlist. You may choose from plotting either the top terms in every
                                    edition or your selected terms <b>By Rank</b> or <b>By P-Value</b>.</p>
                                <p>If <b>By Rank</b> is chosen, you will be shown a Bump Chart of the corresponding terms
                                    and their relative ranks over time. Areas of heavy change will have lots of crossing
                                    lines (and thus appear darker) while areas of stability will have lots of parallel
                                    lines (and thus appear lighter and cleaner)</p>
                            </div>
                        </div>
                    </div>
                    <p:outputPanel id="main-buttons" style="display: inline-block;">
                    <span>
                        <span style="font-size: 1.17em;font-weight:bold;">Graph Top Terms Of All Editions:</span>
                        <p:commandButton
                                disabled="#{not enrichmentView.combinedAnalysis.success}"
                                value="By Rank"
                                style="margin-left:5px;"
                                action="#{enrichmentView.createRankChartByTopN()}"
                                icon="fa fa-line-chart"
                                oncomplete="PF('enrichmentChartWdg').show();handleGraphRankChart(args);"/>
                            <p:commandButton
                                    disabled="#{not enrichmentView.combinedAnalysis.success}"
                                    value="By P-Value"
                                    style="margin-left:5px;"
                                    action="#{enrichmentView.createPValueChartByTopN()}"
                                    icon="fa fa-line-chart"
                                    oncomplete="PF('enrichmentChartWdg').show();handleGraphPValueChart(args);"/>
                        </span>
                    <div style="padding: 0 4px;vertical-align: middle;display: inline-block;">
                        <p:separator style="width:50px;margin:0 auto;"/>
                    </div>
                    <span>
                            <span style="font-size: 1.17em;font-weight:bold;">Graph Selected Terms:</span>
                            <p:commandButton
                                    id="createRankChartBySelected"
                                    disabled="#{not enrichmentView.combinedAnalysis.success}"
                                    value="By Rank"
                                    style="margin-left:5px;"
                                    action="#{enrichmentView.createRankChartBySelected()}"
                                    icon="fa fa-line-chart"
                                    oncomplete="PF('enrichmentChartWdg').show();handleGraphRankChart(args);">
                                <p:confirm header="Confirmation" message="No terms selected, this will plot all terms significant in any edition. This is a lot of data, are you sure?" icon="ui-icon-alert" disabled="#{not empty enrichmentView.selectedEnrichmentTableValues}"/>
                            </p:commandButton>
                            <p:commandButton
                                    id="createPValueChartBySelected"
                                    disabled="#{not enrichmentView.combinedAnalysis.success}"
                                    value="By P-Value"
                                    style="margin-left:5px;"
                                    action="#{enrichmentView.createPValueChartBySelected()}"
                                    icon="fa fa-line-chart"
                                    oncomplete="PF('enrichmentChartWdg').show();handleGraphPValueChart(args);">
                                <p:confirm header="Confirmation" message="No terms selected, this will plot all terms significant in any edition. This is a lot of data, are you sure?" icon="ui-icon-alert" disabled="#{not empty enrichmentView.selectedEnrichmentTableValues}"/>
                            </p:commandButton>
                        </span>
                    </p:outputPanel>
                </div>
                <p:accordionPanel id="main-area" activeIndex="1">
                    <p:tab>
                        <f:facet name="title">
                            <h:outputText value="" styleClass="help-icon" title="This table shows the genes that are responsible for the top 5 terms in this edition."/>
                            <h:outputText value="Genes Backing Top Terms"/>
                        </f:facet>
                        <p:outputPanel id="genesBackingTable">
                            <comps:geneTable value="#{enrichmentView.getGenesBackingTopTermsForEdition(enrichmentView.enrichmentTableEdition)}"/>
                        </p:outputPanel>
                    </p:tab>
                    <p:tab>
                        <f:facet name="title">
                            <h:outputText value="" styleClass="help-icon" a:title-id="#resultsTable-title"/>
                            <div style="display: none;">
                                <div id="resultsTable-title">
                                    <div class="overlay-help">
                                        <p>This table shows enrichment data for those terms that were significantly
                                            enriched in this edition as well as those that were significant at some
                                            point in their history.</p>
                                        <p><b>NOTE:</b> This means that not every term in the table is significant at the
                                            currently chosen edition, but was necessarily significant as some point.</p>
                                    </div>
                                </div>
                            </div>
                            <h:outputText value="Enrichment Results"/>
                        </f:facet>
                        <comps:enrichmentResultsTable
                                id="enrichmentTableContainer"
                                value="#{enrichmentView.enrichmentTableValues}"
                                filteredValue="#{enrichmentView.filteredEnrichmentTableValues}"
                                selection="#{enrichmentView.selectedEnrichmentTableValues}"/>
                    </p:tab>
                </p:accordionPanel>
            </div>


        </h:form>
    </ui:define>
    <ui:define name="dialogs">
        <h:form>
            <p:remoteCommand name="updateCenterPanel" update=":formEnrich"/>

            <p:remoteCommand name="loadPreviousEnrichment"
                             update=":formEnrich:main-area"
                             oncomplete="loadPreviousEnrichmentComplete(xhr, status, args);"
                             action="#{enrichmentView.loadPreviousEnrichment()}"/>

            <p:remoteCommand name="fetchPointData"
                             process="@this"
                             update=":formEnrich:headerPanel, :formEnrich:main-area:genesBackingTable"
                             oncomplete="PF('tableEnrichmentWdg').filter()"
                             action="#{enrichmentView.loadTableData()}"/>

            <p:remoteCommand name="fetchTermInformation"
                             update=":itemSelectEnrichmentDlg"
                             oncomplete="PF('itemSelectEnrichmentWdg').show()"
                             action="#{enrichmentView.fetchTermInformation()}"/>

        </h:form>
        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
            <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
        </p:confirmDialog>

        <p:dialog header="Gene Info" widgetVar="geneDialog" modal="false"
                  showEffect="fade" hideEffect="fade" resizable="false">
            <p:outputPanel id="geneDetail" style="text-align:center;">
                <p:panelGrid>
                    <p:row>
                        <p:column>
                            <h:outputText value="Symbol"/>
                        </p:column>
                        <p:column>
                            <a href="http://www.uniprot.org/uniprot/#{enrichmentView.viewGene.accession.accession}"
                               target="_blank" style="margin-right: 5px; text-decoration: none;">
                                <h:graphicImage library="img" width="18" height="12" name="uniprot_logo.png" style="vertical-align: text-top;" styleClass="emphasize-hover"/>
                            </a>
                            <p:link value="#{enrichmentView.viewGene.symbol}" outcome="genes" target="_blank">
                                <f:param name="accession" value="#{enrichmentView.viewGene.accession.accession}"/>
                            </p:link>
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column>
                            <h:outputText value="Accession"/>
                        </p:column>
                        <p:column>
                        <span class="sqlDialogText">
                            <a href="http://www.uniprot.org/uniprot/#{enrichmentView.viewGene.accession.accession}"
                               target="_blank">#{enrichmentView.viewGene.accession.accession}</a>
                        </span>
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column>
                            <h:outputText value="Description"/>
                        </p:column>
                        <p:column>
                            <h:outputText value="#{enrichmentView.viewGene.name}"
                                          styleClass="sqlDialogText"/>
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column>
                            <h:outputText value="Synonyms"/>
                        </p:column>
                        <p:column>
                        <span class="sqlDialogText">
                            <h:outputText value="#{enrichmentView.viewGene.synonyms.stream().reduce((p1, p2) -> p1 += ', ' += p2).get()}"/>
                        </span>

                        </p:column>
                    </p:row>


                </p:panelGrid>
            </p:outputPanel>
        </p:dialog>

        <p:dialog id="graphDlg"
                  header="Ancestor Chart"
                  widgetVar="graphDlgWdg"
                  modal="false"
                  showEffect="fade"
                  hideEffect="fade"
                  resizable="false"
                  height="600px;"
                  width="800px;"
                  style="max-width:80%;max-height:80%;"
                  closeOnEscape="true"
        >
            <f:facet name="footer">
                <p:commandButton  value="Toggle Child Nodes"
                                  type="button"
                                  style="right:0" onclick="gograph.toggleChildNodes('#dagDialog')"/>
            </f:facet>
            <div id="dagDialog">
                <div style="height:500px;width:700px;">buffer</div>
            </div>
        </p:dialog>

        <p:dialog id="itemSelectEnrichmentDlg" header="Data Point Information"
                  widgetVar="itemSelectEnrichmentWdg" modal="false" showEffect="fade"
                  hideEffect="fade" resizable="false" dynamic="true">
            <p:outputPanel id="termDetail" style="text-align:center;">
                <p:panelGrid columns="2">

                    <h:outputText value="Edition" title="Edition for the selected time-point."/>
                    <h:outputText value="#{enrichmentView.selectedEdition.edition}"
                                  styleClass="sqlDialogText"/>

                    <h:outputText value="Date" title="Date for the selected time-point."/>
                    <h:outputText value="#{enrichmentView.selectedEdition.date}"
                                  styleClass="sqlDialogText"/>

                    <h:outputText value="GOID" title="Gene Ontology ID of the selected term."/>
                    <h:outputText value="#{enrichmentView.selectedTerm.goId}"
                                  styleClass="sqlDialogText"/>

                    <h:outputText value="Aspect" title="One of Biological Process, Cellular Component, or Molecular Function."/>
                    <h:outputText value="#{enrichmentView.selectedTerm.aspect}"
                                  styleClass="sqlDialogText"/>

                    <h:outputText value="Name" title="Short description of the selected term."/>
                    <h:outputText value="#{enrichmentView.selectedTerm.name}"
                                  styleClass="sqlDialogText"/>

                    <h:outputText value="P-Value" title="Raw P-value."/>
                    <h:outputText value="#{enrichmentView.selectedEnrichmentResult.pvalue}"
                                  rendered="#{enrichmentView.selectedEnrichmentResult.pvalue lt 0.0001}">
                        <f:convertNumber type="number" pattern="#.##E0"/>
                    </h:outputText>
                    <h:outputText value="#{enrichmentView.selectedEnrichmentResult.pvalue}"
                                  rendered="#{enrichmentView.selectedEnrichmentResult.pvalue ge 0.0001}">
                        <f:convertNumber type="number" pattern="0.######"/>
                    </h:outputText>

                    <h:outputText value="Absolute Rank" title="Fractional rank of this terms p-value in this edition."/>
                    <h:outputText
                            value="#{enrichmentView.selectedEnrichmentResult.fractionalRank}"
                            styleClass="sqlDialogText"/>

                    <h:outputText value="#{enrichmentView.selectedValueName}"
                                  rendered="#{enrichmentView.selectedValueName != null}"/>
                    <h:outputText value="#{enrichmentView.selectedValue}"
                                  styleClass="sqlDialogText"
                                  rendered="#{enrichmentView.selectedValueName != null}"/>

                    <h:outputText value="Stability Score" title="Recent stability score."/>
                    <h:outputText value="#{enrichmentView.selectedStabilityScore.score}"
                                  styleClass="sqlDialogText"
                                  rendered="#{enrichmentView.selectedStabilityScore.score != 'NaN' and enrichmentView.selectedStabilityScore.score != 'Infinity'}">
                        <f:convertNumber type="number"/>
                    </h:outputText>
                    <h:outputText value="No Data"
                                  styleClass="sqlDialogText"
                                  rendered="#{enrichmentView.selectedStabilityScore.score == 'NaN'}"/>
                    <h:outputText value="No Change"
                                  styleClass="sqlDialogText"
                                  rendered="#{enrichmentView.selectedStabilityScore.score == 'Infinity'}"/>

                    <h:outputText value="Stability Score Avg" title="Mean stability score up to this edition."/>
                    <h:outputText value="#{enrichmentView.selectedStabilityScore.averageScore}"
                                  styleClass="sqlDialogText"
                                  rendered="#{enrichmentView.selectedStabilityScore.averageScore != 'NaN' and enrichmentView.selectedStabilityScore.averageScore != 'Infinity'}">
                        <f:convertNumber type="number"/>
                    </h:outputText>
                    <h:outputText value="No Data"
                                  styleClass="sqlDialogText"
                                  rendered="#{enrichmentView.selectedStabilityScore.averageScore == 'NaN'}"/>
                    <h:outputText value="No Change"
                                  styleClass="sqlDialogText"
                                  rendered="#{enrichmentView.selectedStabilityScore.averageScore == 'Infinity'}"/>

                </p:panelGrid>
            </p:outputPanel>
        </p:dialog>
        <p:dialog id="chartDlg" widgetVar="chartDlgWdg" modal="true" showEffect="fade"
                  hideEffect="fade" resizable="false" height="800" width="1200"
                  fitViewport="true" closeOnEscape="true" maximizable="false">
            <div id="hc_chart_dlg_container" style="width: 100%; height: 100%;">
            </div>
        </p:dialog>
        <p:dialog id="enrichmentChartDlg" widgetVar="enrichmentChartWdg" modal="true" showEffect="fade"
                  hideEffect="fade" resizable="true" height="800" width="1200"
                  fitViewport="true" closeOnEscape="true" maximizable="true"
                  onHide="enrichmentChartHide()">
            <!-- return false so that the ajax request is not executed. -->
            <p:ajax event="maximize"
                    onstart="enrichmentChartDlgResize();return false;"/>
            <p:ajax event="restoreMaximize"
                    onstart="enrichmentChartDlgResize();return false;"/>
            <div id="hc_container" style="width: 100%; height: 100%;">
                <div id="hc_enrichment_container" style="width: 100%; height: 100%;"></div>
                <!--<div style="text-align: center;color: #666666;margin-top: 10px;">Zoom an area by dragging across this chart</div>-->
                <!--<div id="hc_enrichmentMaster_container"-->
                     <!--style="width: 100%; height: 15%; border: solid; border-width: thin;"></div>-->
            </div>

        </p:dialog>

        <p:dialog id="stabilityChartDlg" widgetVar="stabilityChartWdg" modal="true" showEffect="fade"
                  hideEffect="fade" resizable="false" height="800" width="1200"
                  fitViewport="true" closeOnEscape="true" maximizable="false">
            <f:facet name="header">
                <h:outputText value="" styleClass="help-icon" a:title-id="#stabilityChart-title"/>
                <div style="display: none;">
                    <div id="stabilityChart-title">
                        <div class="overlay-help">
                            <p>Plot of the selected term's p-value and 95% confidence interval over its history.</p>
                            <p>
                                This is calculated using <i>six month rolling regressions</i> on the historical changes in
                                'Pop. Hits' and 'Hits'. Given the results of these regressions we use their 95% confidence
                                intervals to calculate a 95% confidence interval around the p-value. This range is then used
                                to calculate the negative log of the coefficient of variation with respect to that edition's
                                significance cutoff to get the stability score.
                            </p>
                            <p>
                                The stability score typically ranges between -10 and 10 with 10 being more
                                stable than -10.
                            </p>
                            <p>
                                A score of <b>No Change</b> means we saw no significant variation in both
                                Pop. Hits and Hits over its recent past (keep in mind this does <b>not</b> mean the p-value
                                is constant).
                            </p>
                            <p>A score of <b>No Data</b> means there was not enough available.</p>
                        </div>
                    </div>
                </div>
                <h:outputText value="Stability"/>
            </f:facet>
            <div style="width: 100%; height: 100%;">
                <div id="hc_stability_container" style="width: 100%; height: 100%;"></div>
            </div>

        </p:dialog>

        <h:form id="formAddGenes">
            <p:dialog header="Add Gene" widgetVar="addGenesDlg" modal="false"
                      showEffect="fade" hideEffect="fade" resizable="false"
                      styleClass="center-footer">
                <p:panelGrid style="margin-bottom:10px" cellpadding="5"
                             styleClass="no-border">
                    <p:row>
                        <p:column>
                            <h:outputText value="Single Gene: "/>
                        </p:column>
                        <p:column>
                            <p:autoComplete value="#{enrichmentView.queryGene}"
                                            completeMethod="#{enrichmentView.complete}" minQueryLength="2"
                                            forceSelection="true" label="ID" maxResults="10"
                                            emptyMessage="No gene suggestions available,  please try again."
                                            var="genematch" itemLabel="#{genematch.symbol}" itemValue="#{genematch}"
                                            groupBy="#{genematch.level.label}"
                                            placeholder="BRCA1" converter="geneMatchConverter"
                                            panelStyleClass="force-fit-content"
                                            panelStyle="max-width: 500px;min-width:250px;">
                                <p:ajax event="itemSelect" process="@this"/>
                                <p:column>
                                    <h:outputText
                                            value="#{genematch.selectedGene.symbol} - #{genematch.selectedGene.name}"/>
                                </p:column>
                            </p:autoComplete>
                        </p:column>
                    </p:row>
                </p:panelGrid>


                <f:facet name="footer">
                    <p:commandButton value="&#160; Add"
                                     action="#{enrichmentView.addGene()}" icon="fa fa-plus"
                                     update=":formSelect:geneList, :globalGrowl, :formSelect:runEnrichmentBtn"
                                     oncomplete="PF('addGenesDlg').hide();"/>
                </f:facet>

            </p:dialog>

            <p:dialog header="Add Multiple Genes" widgetVar="addMultipleGenesDlg"
                      modal="false" showEffect="fade" hideEffect="fade" resizable="false"
                      styleClass="center-footer">

                <h:panelGrid style="margin-bottom:10px" cellpadding="5" columns="1"
                             columnClasses="center">

                    <p:inputTextarea value="#{enrichmentView.bulkQuery}" rows="10"
                                     cols="50" placeholder="BRCA1 GRIN1 RB1"
                                     title="whitespace or newline delimited" autoResize="false"/>


                </h:panelGrid>

                <f:facet name="footer">
                    <p:commandButton value="&#160; Add All"
                                     action="#{enrichmentView.searchMultipleGenes()}"
                                     icon="fa fa-plus-circle"
                                     update=":globalGrowl, :formAddGenes:tableConfirmGenes"
                                     oncomplete="PF('addMultipleGenesDlg').hide();PF('confirmGenesDlg').show()"/>
                </f:facet>

            </p:dialog>

            <p:dialog header="Confirm Selection" widgetVar="confirmGenesDlg"
                      modal="false" showEffect="fade" hideEffect="fade" resizable="false"
                      style="height:600px;width:900px;">

                <p:dataTable id="tableConfirmGenes" var="gm"
                             value="#{enrichmentView.geneMatches}" editable="true"
                             style="margin-bottom:20px;width:800px" scrollable="true"
                             scrollHeight="400"
                             rowStyleClass="#{gm.type == 'SINGLE' ? 'green-row' : 'red-row'}">

                    <p:column headerText="Input" style="width:100px;">
                        <h:outputText value="#{gm.querySymbol}"/>
                    </p:column>

                    <p:column headerText="Selected Gene" style="width:120px;">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText
                                        value="#{gm.selectedGene.symbol} #{empty gm.selectedGene ? '' : '-'} #{gm.selectedGene.accession.accession}"/>
                            </f:facet>
                            <f:facet name="input">
                                <p:autoComplete value="#{gm.selectedGene}"
                                                completeMethod="#{enrichmentView.complete}" minQueryLength="2"
                                                forceSelection="true" label="ID" maxResults="10"
                                                emptyMessage="No gene suggestions available, please try again."
                                                var="gm2" itemLabel="#{gm2.symbol}" itemValue="#{gm2}"
                                                groupBy="#{gm2.level.label}"
                                                placeholder="BRCA1" converter="geneMatchConverter"
                                                panelStyleClass="force-fit-content"
                                                panelStyle="max-width: 500px;min-width:250px;">
                                    <p:column>
                                        <h:outputText value="#{gm2.selectedGene.symbol} - #{gm2.selectedGene.name}"/>
                                    </p:column>
                                </p:autoComplete>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                    <p:column headerText="Description">
                        <h:outputText style="width:160px;" rendered="${gm.selectedGene.name.length() le 45}"
                                      value="#{gm.selectedGene.name}"/>
                        <h:outputText style="width:160px;" rendered="${gm.selectedGene.name.length() > 45}"
                                      value="${''.concat(fn:substring(gm.selectedGene.name, 0, 45)).concat('...')}"
                                      title="#{gm.selectedGene.name}"/>
                    </p:column>

                    <p:column headerText="Match Type" style="width:150px;">
                        <h:outputText value="#{gm.type.label} - #{gm.level.label}"/>
                    </p:column>


                    <p:column style="width:36px">
                        <p:rowEditor/>
                    </p:column>

                    <f:facet name="footer">
                        <h:outputText value=""/>
                    </f:facet>
                </p:dataTable>

                <f:facet name="footer">
                    <p:commandButton value="&#160; Confirm"
                                     action="#{enrichmentView.confirmMatches()}"
                                     icon="fa fa-plus-circle"
                                     update=":globalGrowl, :formSelect:geneList, :formSelect:runEnrichmentBtn"
                                     oncomplete="PF('confirmGenesDlg').hide();"/>
                </f:facet>

            </p:dialog>

        </h:form>
    </ui:define>
</ui:composition>